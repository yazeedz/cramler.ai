services:
  # CrewAI Product Research Agent
  crewai-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: crewai-product-research
    ports:
      - "8000:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - SERPAPI_API_KEY=${SERPAPI_API_KEY}
      - FIRECRAWL_URL=${FIRECRAWL_URL:-http://host.docker.internal:3002}
      - PORT=8000
    env_file:
      - .env
    restart: unless-stopped
    networks:
      - cramler-network
      - shared-network
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # WebSocket Server for real-time product updates
  websocket-server:
    build:
      context: ../server
      dockerfile: Dockerfile
    container_name: cramler-websocket-server
    ports:
      - "3001:3001"
    environment:
      - WS_SERVER_PORT=3001
      - N8N_PRODUCT_WEBHOOK_URL=https://n8n.cramler.ai/webhook/product-lookup
      - N8N_BRAND_WEBHOOK_URL=https://n8n.cramler.ai/webhook/brand-research
      - N8N_COMPETITOR_WEBHOOK_URL=https://n8n.cramler.ai/webhook/competitor-research
      - N8N_PROMPT_GENERATION_WEBHOOK_URL=https://n8n.cramler.ai/webhook/generate-prompts
      - CREWAI_URL=http://crewai-agent:8000
    env_file:
      - ../server/.env
    restart: unless-stopped
    networks:
      - cramler-network
    depends_on:
      - crewai-agent
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  # # n8n Workflow Automation
  # n8n:
  #   image: n8nio/n8n:latest
  #   container_name: cramler-n8n
  #   ports:
  #     - "5678:5678"
  #   environment:
  #     - N8N_BASIC_AUTH_ACTIVE=false
  #     - N8N_HOST=localhost
  #     - N8N_PORT=5678
  #     - N8N_PROTOCOL=http
  #     - WEBHOOK_URL=http://localhost:5678/
  #     - GENERIC_TIMEZONE=UTC
  #     - OPENAI_API_KEY=${OPENAI_API_KEY}
  #   env_file:
  #     - .env
  #   volumes:
  #     - n8n_data:/home/node/.n8n
  #   restart: unless-stopped
  #   networks:
  #     - cramler-network
  #   healthcheck:
  #     test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5678/healthz"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 10s

networks:
  cramler-network:
    driver: bridge

volumes:
  n8n_data:
    external: true
